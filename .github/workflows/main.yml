
name: Test and Release


on:
  push:
    branches:
     - 'main'
     - 'feature/*'
     - 'hotfix/*'
    tags:
     - 'v*' 
  pull_request:
    branches:
      - main

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  Test:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v2
        if: ${{ startsWith(github.ref, 'refs/tags') }}

      - name: Create conda environment and run unit tests
        run: |
          call %CONDA%\Scripts\activate
          call conda env create -f environment.yml -n condansis
        shell: cmd
        
      - name: Install condansis and run test
        run: |
          call %CONDA%\Scripts\activate condansis
          call conda install pytest wheel
          python -m pip install .\src
          python -m pytest --junitxml=test-results.xml .\src
        shell: cmd
        
      - name: Run script example 
        run: |
          call %CONDA%\Scripts\activate condansis
          python example\script\create_installer.py
          start /wait "" install_snake-simulator-0.1.exe /S /D=%cd%\example_package_1
          example_package_1\snake.lnk
        shell: cmd
        
      - name: Run package example 
        run: |
          call %CONDA%\Scripts\activate condansis
          python example\package\create_installer.py
          start /wait "" install_snake-simulator-1.0.exe /S /D=%cd%\example_package_2
          example_package_2\snake.lnk
        shell: cmd
        
  Release:
    runs-on: ubuntu-latest
    #if: ${{ startsWith(github.ref, 'refs/tags') }}
      
    steps:
      - uses: actions/checkout@v2
      
      - uses: actions/setup-python@v2
        with:
          python-version: '3.8'
          architecture: 'x64'

      - name: Build and upload to PyPI
        run: |
          cd src
          python -m pip install --upgrade setuptools wheel twine
          python setup.py bdist_wheel
          python setup.py sdist
          python -m twine upload --repository testpypi .\dist\*.whl -u __token__ -p "$env:PASSWORD"
        env:
          PASSWORD: ${{ secrets.PYPI_TOKEN }}
